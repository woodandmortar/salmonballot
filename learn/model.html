<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot</title>
    <style>
        .chat-window, .json-editor {
            width: 300px;
            height: 400px;
            border: 1px solid #ccc;
            overflow-y: scroll;
            margin-bottom: 10px;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>
</head>
<body>

<div class="chat-window" id="chatWindow"></div>
<input type="text" id="userInput" placeholder="Type your message...">
<button onclick="sendMessage()">Send</button>

<h3>JSON Editor</h3>
<div id="editorInstructions" style="color: red; margin-bottom: 10px;"></div>
<textarea class="json-editor" id="jsonEditor" placeholder="Format: [question, answer, liveChange]"></textarea>

<input type="file" id="baseDataSet" onchange="importBaseDataSet(event)" placeholder="Import Base Data Set">
<input type="file" id="conversationDataSet" onchange="importConversationDataSet(event)" placeholder="Import Conversation Data Set">
<button onclick="compileAndExportJSON()">Export Data</button>
<button onclick="updateConversationData()">Update</button>

<script>
    let baseData = [];
    let conversationData = [];
    let chatHistory = [];

    function normalizeString(str) {
        return str.toLowerCase().replace(/[.,!?;()"'-]/g, '').replace(/\s+/g, ' ').trim();
    }

    function updateJSONDisplay() {
        const jsonEditor = document.getElementById('jsonEditor');
        jsonEditor.value = JSON.stringify(conversationData, null, 2);
    }

    function sendMessage() {
        const inputElem = document.getElementById('userInput');
        const message = inputElem.value;
        inputElem.value = '';

        const chatWindow = document.getElementById('chatWindow');
        chatWindow.innerHTML += '<p>User: ' + message + '</p>';

        const response = getResponse(message);
        chatWindow.innerHTML += '<p>Bot: ' + response + '</p>';

        // Update the conversationData with the new question and response
        conversationData.push([message, response, ""]);

        // Update the JSON editor to reflect the changes
        updateJSONDisplay();

        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function getResponse(message) {
        const normalizedMessage = normalizeString(message);
        let response = searchInData(normalizedMessage, baseData);
        if (!response) {
            response = searchInData(normalizedMessage, conversationData);
        }
        if (!response) {
            promptForCorrectResponse(normalizedMessage);
            return 'I don\'t know how to answer that. Please provide the correct response in the JSON Editor below.';
        }
        return response;
    }

    function promptForCorrectResponse(question) {
        const editorInstructions = document.getElementById('editorInstructions');
        editorInstructions.innerHTML = 'Unknown question: ' + question + '. Please provide the correct response below and press the "Update" button.';

        const jsonEditor = document.getElementById('jsonEditor');
        jsonEditor.value = JSON.stringify([question, "YOUR RESPONSE HERE", ""], null, 2);

        // Clear the instructions after 4 seconds
        setTimeout(() => {
            editorInstructions.innerHTML = '';
        }, 4000);
    }

    function searchInData(message, data) {
        for (const entry of data) {
            if (normalizeString(message).includes(normalizeString(entry[0]))) {
                return entry[1];
            }
        }
        return null;
    }

    function importBaseDataSet(event) {
        const files = event.target.files;
        if (files.length === 0) {
            alert("No file selected. Please select a file and try again.");
            return;
        }
        const file = files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                baseData = JSON.parse(e.target.result);
                event.target.disabled = true; // Disable the base data set input after uploading
            } catch (error) {
                alert("Error parsing base data set: " + error.message);
            }
        };
        reader.readAsText(file);
    }

    function importConversationDataSet(event) {
        const files = event.target.files;
        if (files.length === 0) {
            alert("No file selected. Please select a file and try again.");
            return;
        }
        const file = files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                conversationData = JSON.parse(e.target.result);
                updateJSONDisplay();
            } catch (error) {
                alert("Error parsing conversation data set: " + error.message);
            }
        };
        reader.readAsText(file);
    }

    function compileAndExportJSON() {
        const jsonEditor = document.getElementById('jsonEditor');
        const blob = new Blob([jsonEditor.value], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'compiledData.json';
        a.click();
    }

    function updateConversationData() {
        const jsonEditor = document.getElementById('jsonEditor');
        try {
            const newData = JSON.parse(jsonEditor.value);
            if (Array.isArray(newData) && newData.length === 3) {
                conversationData.push(newData);
                updateJSONDisplay();
                alert("Data updated successfully!");
            } else {
                alert("Invalid data format. Please ensure you have the format [question, answer, liveChange].");
            }
        } catch (error) {
            alert("Error updating data: " + error.message);
        }
    }

    // Initialize by asking for base data set
    const chatWindow = document.getElementById('chatWindow');
    chatWindow.innerHTML += '<p>Bot: Please provide a base data set for me to start with.</p>';

</script>

</body>
</html>
